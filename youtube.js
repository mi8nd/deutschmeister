const YOUTUBE_API_KEY = "AIzaSyAX98Zxj_nhT0GgMq9YxoZNodeHMYmr1ZY";

export const PLAYLISTS = {
  A1: 'PLF9mJC4RrjIhS4MMm0x72-qWEn1LRvPuW',
  A2: 'PLF9mJC4RrjIhv0_YjWvC0pmM1EZlVylBt',
  B1: 'PLF9mJC4RrjIhhEGuI2x4_WWaIyn9q7MzV',
  B2: 'PLF9mJC4RrjIirvi-7FRT0hPbdfwcmFDH1',
  C1: 'PLF9mJC4RrjIjlxkiVa8VEG55Lp9TcJMKP',
};

export const CUSTOM_TITLES = {
  en: {
    A1: ["Greetings", "Common Phrases", "Numbers 0-20", "Numbers 21-100", "The Alphabet", "Introducing Yourself", "Getting to Know Someone", "How Are You?", "Sentence Structure Part 1", "Sentence Structure Part 2", "Personal Pronouns", "Verbs 'haben' and 'sein'", "What is a Verb?", "Regular Verbs", "Irregular Verbs", "Numbers Above 100", "Adjectives and Opposites", "Introducing Someone Else", "Definite Articles", "Indefinite Articles", "Negative Articles", "Telling Time (Official)", "Telling Time (Unofficial)", "Possessive Articles", "The Family", "Accusative Case", "Possessive Articles (Accusative)", "Modal Verb 'möchten'", "W-Questions (Question Words)", "Ordering in a Restaurant", "Personal Pronouns (Accusative)", "Dative Case Articles", "Ordinal Numbers", "Time-related Questions", "Possessive Articles (Dative)", "Personal Pronouns (Dative)", "Separable Verbs", "Daily Routine", "Imperative Mood", "Giving Directions", "Past Tense 'war' vs 'hatte'", "Inseparable Verbs", "Being Sick", "Perfect Tense Part 1", "Perfect Tense Part 2", "Perfect Tense Part 3", "Past Tense: What did you do on vacation?", "In the Supermarket", "How's the Weather?", "Making Appointments", "Writing a Letter (Invitation)", "Expressing Likes and Dislikes", "Question Pronoun 'welch-'", "Demonstrative Article 'dies-'", "Buying Clothes", "Taking a Taxi", "Adverbs of Time", "Speaking on the Phone", "At the Doctor's Office", "Writing a Formal Letter", "Filling out a Form", "At the Post Office", "At the Bank", "Apartment Hunting", "Buying a Train Ticket", "A1 Level Test"],
    A2: ["Introducing Yourself (Advanced)", "Character Traits", "Subordinate Clause with 'dass'", "Causal Clauses: 'weil' vs 'denn'", "Adjective Endings (Nominative)", "Adjective Endings (Accusative)", "Adjective Endings (Dative)", "Conditional Clauses with 'wenn'", "Genitive Case", "Adjective Endings (Genitive)", "Comparative and Superlative Part 1", "Comparative and Superlative Part 2", "Concessive Clauses with 'obwohl'", "Connectors 'deshalb' and 'trotzdem'", "The Verb 'werden'", "Indirect Questions with 'ob'", "Temporal Clauses: 'während' & 'bevor'", "Relative Clauses (Nominative)", "Relative Clauses (Accusative)", "Relative Clauses (Dative)", "Relative Clauses (Genitive)", "Relative Pronouns 'wer' and 'was'", "Indefinite Pronouns", "Simple Past (Modal Verbs)", "Simple Past (Regular Verbs)", "Simple Past (Irregular Verbs)", "Temporal Clauses with 'als'", "Describing Your Childhood", "City Life vs. Country Life", "Infinitive with 'zu'", "Infinitive without 'zu'", "Past Perfect Tense (Plusquamperfekt)", "Temporal Conjunctions: 'nachdem' & 'seitdem'", "Two-Way Prepositions", "Making Assumptions", "Polite Requests (Konjunktiv II)", "Describing a Picture", "Nouns from Adjectives", "Passive Voice Part 1", "Passive Voice Part 2", "Writing a Recipe", "Giving Advice ('sollte')", "Writing an SMS (Goethe A2)", "Expressing Feelings", "Dream Jobs", "Weather Forecast", "Semi-Formal Letter (Goethe A2)", "Writing a Postcard about Vacation", "Planning Something Together (Goethe A2)", "10 Authentic Dialogues"],
    B1: ["Reflexive Verbs", "Reflexive Verbs Part 2", "Reciprocal Verbs", "Noun-Verb Combinations", "The Verb 'lassen'", "Passive with 'sich lassen'", "'lassen' with Prefixes", "N-Declension (Weak Nouns)", "Genitive Prepositions: 'wegen', 'während', 'trotz'", "Da-Compounds", "Da-Compounds Part 2", "Wo-Compounds", "Instrumental Clauses: 'indem'", "Final Clauses: 'damit', 'um...zu'", "Clauses with 'ohne...zu'", "Clauses with 'anstatt...zu'", "Using 'brauchen + zu'", "Genitive Prepositions Part 2", "Present Participle (Partizip I)", "Past Participle (Partizip II)", "Statal Passive (Zustandspassiv)", "Subjunctive II (Konjunktiv II): Usage", "Subjunctive II: Verb Conjugation", "Subjunctive II: Past Tense", "Subjunctive II: Unreal Wishes", "Writing a Semi-Formal Letter (Goethe B1)", "Expressing Your Opinion (Goethe B1)", "Position of 'nicht'", "More Genitive Prepositions", "Giving a Presentation (Goethe B1)", "Making a Complaint", "My City, My Home", "Adverbs of Time (Temporaladverbien)", "Environment and Conservation", "Job Search: Reading Ads", "Job Search: Writing a CV/Resume", "Job Search: Cover Letter", "Job Search: The Job Interview", "Future Tense I (Futur I)"],
    B2: ["Two-Part Connectors", "Separable Prefixes Part 1", "Separable Prefixes Part 2", "Separable Prefixes Part 3", "Separable Prefixes Part 4", "Inseparable Prefixes Part 1", "Inseparable Prefixes Part 2", "Passive Voice Alternatives", "Indefinite Pronouns with 'irgend-'", "Words of Negation", "The Pronoun 'es'", "Indefinite Pronouns Part 1", "Indefinite Pronouns Part 2", "B2.1 Level Test", "B2.2 Level Test", "B2.2 Radio Interview (Listening)", "Test Your Language Intuition (B2)"],
    C1: ["Future Tense I and II", "Genitive Prepositions (Advanced)", "Test Your Language Intuition (C1)", "What are Modal Verbs?", "Modal Verb 'dürfen'", "Modal Verb 'können'", "Modal Verb 'sollen'", "Modal Verb 'wollen'", "Modal Verb 'mögen/möchten'", "Modal Verb 'müssen'", "Subjective Meaning of Modal Verbs Part 1", "Subjective Meaning of Modal Verbs Part 2", "Alternatives to Modal Verbs Part 1", "Alternatives to Modal Verbs Part 2"]
  },
  de: {
    A1: ["Begrüßungen", "Alltägliche Sätze", "Zahlen 0-20", "Zahlen 21-100", "Das Alphabet", "Sich vorstellen", "Jemanden kennenlernen", "Wie geht's?", "Satzstruktur Teil 1", "Satzstruktur Teil 2", "Personalpronomen", "Verben 'haben' und 'sein'", "Was ist ein Verb?", "Regelmäßige Verben", "Unregelmäßige Verben", "Zahlen über 100", "Adjektive und Gegensätze", "Jemanden vorstellen", "Bestimmte Artikel", "Unbestimmte Artikel", "Negativartikel", "Uhrzeit (offiziell)", "Uhrzeit (inoffiziell)", "Possessivartikel", "Die Familie", "Akkusativ", "Possessivartikel (Akkusativ)", "Modalverb 'möchten'", "W-Fragen", "Im Restaurant bestellen", "Personalpronomen (Akkusativ)", "Dativ-Artikel", "Ordinalzahlen", "Fragen zur Zeit", "Possessivartikel (Dativ)", "Personalpronomen (Dativ)", "Trennbare Verben", "Tagesablauf", "Imperativ", "Wegbeschreibung", "Präteritum: 'war' vs. 'hatte'", "Untrennbare Verben", "Krank sein", "Perfekt Teil 1", "Perfekt Teil 2", "Perfekt Teil 3", "Perfekt: Was hast du im Urlaub gemacht?", "Im Supermarkt", "Wie ist das Wetter?", "Verabredungen treffen", "Brief schreiben (Einladung)", "Gefallen und Missfallen ausdrücken", "Fragepronomen 'welch-'", "Demonstrativartikel 'dies-'", "Kleidung kaufen", "Taxi fahren", "Zeitadverbien", "Am Telefon sprechen", "Beim Arzt", "Einen formellen Brief schreiben", "Ein Formular ausfüllen", "Bei der Post", "Bei der Bank", "Wohnungssuche", "Eine Fahrkarte kaufen", "A1-Niveautest"],
    A2: ["Sich vorstellen (Fortgeschritten)", "Charaktereigenschaften", "Nebensatz mit 'dass'", "Kausalsätze: 'weil' vs. 'denn'", "Adjektivdeklination (Nominativ)", "Adjektivdeklination (Akkusativ)", "Adjektivdeklination (Dativ)", "Bedingungssätze mit 'wenn'", "Genitiv", "Adjektivdeklination (Genitiv)", "Komparativ und Superlativ Teil 1", "Komparativ und Superlativ Teil 2", "Konzessivsätze mit 'obwohl'", "Konnektoren 'deshalb' und 'trotzdem'", "Das Verb 'werden'", "Indirekte Fragesätze mit 'ob'", "Temporalsätze: 'während' & 'bevor'", "Relativsätze (Nominativ)", "Relativsätze (Akkusativ)", "Relativsätze (Dativ)", "Relativsätze (Genitiv)", "Relativpronomen 'wer' und 'was'", "Indefinitpronomen", "Präteritum (Modalverben)", "Präteritum (regelmäßige Verben)", "Präteritum (unregelmäßige Verben)", "Temporalsätze mit 'als'", "Die eigene Kindheit beschreiben", "Stadtleben vs. Landleben", "Infinitiv mit 'zu'", "Infinitiv ohne 'zu'", "Plusquamperfekt", "Temporale Konjunktionen: 'nachdem' & 'seitdem'", "Wechselpräpositionen", "Vermutungen äußern", "Höfliche Bitten (Konjunktiv II)", "Bildbeschreibung", "Substantivierte Adjektive", "Passiv Teil 1", "Passiv Teil 2", "Ein Rezept schreiben", "Ratschläge geben ('sollte')", "Eine SMS schreiben (Goethe A2)", "Gefühle ausdrücken", "Traumberufe", "Wettervorhersage", "Halbformeller Brief (Goethe A2)", "Postkarte aus dem Urlaub", "Etwas gemeinsam planen (Goethe A2)", "10 authentische Dialoge"],
    B1: ["Reflexivverben", "Reflexivverben Teil 2", "Reziproke Verben", "Nomen-Verb-Verbindungen", "Das Verb 'lassen'", "Passiv mit 'sich lassen'", "'lassen' mit Präfixen", "N-Deklination", "Genitivpräpositionen: 'wegen', 'während', 'trotz'", "Da-Komposita", "Da-Komposita Teil 2", "Wo-Komposita", "Instrumentalsätze: 'indem'", "Finalsätze: 'damit', 'um...zu'", "Sätze mit 'ohne...zu'", "Sätze mit 'anstatt...zu'", "Verwendung von 'brauchen + zu'", "Genitivpräpositionen Teil 2", "Partizip I", "Partizip II", "Zustandspassiv", "Konjunktiv II: Gebrauch", "Konjunktiv II: Konjugation der Verben", "Konjunktiv II: Vergangenheit", "Konjunktiv II: Irreale Wünsche", "Einen halbformellen Brief schreiben (Goethe B1)", "Die eigene Meinung äußern (Goethe B1)", "Position von 'nicht'", "Weitere Genitivpräpositionen", "Eine Präsentation halten (Goethe B1)", "Etwas reklamieren", "Meine Stadt, meine Heimat", "Temporaladverbien", "Umwelt und Umweltschutz", "Jobsuche: Anzeigen lesen", "Jobsuche: Lebenslauf schreiben", "Jobsuche: Bewerbungsschreiben", "Jobsuche: Das Vorstellungsgespräch", "Futur I"],
    B2: ["Zweiteilige Konnektoren", "Trennbare Präfixe Teil 1", "Trennbare Präfixe Teil 2", "Trennbare Präfixe Teil 3", "Trennbare Präfixe Teil 4", "Untrennbare Präfixe Teil 1", "Untrennbare Präfixe Teil 2", "Passiversatzformen", "Indefinitpronomen mit 'irgend-'", "Negationswörter", "Das Pronomen 'es'", "Indefinitpronomen Teil 1", "Indefinitpronomen Teil 2", "B2.1-Niveautest", "B2.2-Niveautest", "B2.2-Radiointerview (Hören)", "Teste dein Sprachgefühl (B2)"],
    C1: ["Futur I und II", "Genitivpräpositionen (Fortgeschritten)", "Teste dein Sprachgefühl (C1)", "Was sind Modalverben?", "Modalverb 'dürfen'", "Modalverb 'können'", "Modalverb 'sollen'", "Modalverb 'wollen'", "Modalverb 'mögen/möchten'", "Modalverb 'müssen'", "Subjektive Bedeutung der Modalverben Teil 1", "Subjektive Bedeutung der Modalverben Teil 2", "Alternativen zu Modalverben Teil 1", "Alternativen zu Modalverben Teil 2"]
  }
};

async function fetchPlaylistVideoCounts() {
  const playlistIds = Object.values(PLAYLISTS).join(',');
  const url = `https://www.googleapis.com/youtube/v3/playlists?part=contentDetails&id=${playlistIds}&key=${YOUTUBE_API_KEY}`;
  try {
    const response = await fetch(url);
    const data = await response.json();
    if (!response.ok) throw new Error(data.error.message || "Failed to fetch from YouTube API");
    const videoCounts = {};
    data.items.forEach(item => {
      const level = Object.keys(PLAYLISTS).find(key => PLAYLISTS[key] === item.id);
      if (level) { videoCounts[level] = { totalVideos: item.contentDetails.itemCount, playlistId: item.id }; }
    });
    return videoCounts;
  } catch (error) {
    console.error("Error fetching playlist counts:", error);
    throw error;
  }
}

async function fetchVideosForPlaylist(playlistId, language) {
  let allVideos = [];
  let nextPageToken = '';
  const urlBase = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=${playlistId}&key=${YOUTUBE_API_KEY}`;
  try {
    do {
      const url = nextPageToken ? `${urlBase}&pageToken=${nextPageToken}` : urlBase;
      const response = await fetch(url);
      const data = await response.json();
      if (!response.ok) throw new Error(data.error.message);
      const videos = data.items.map(item => {
        const thumbnails = item.snippet.thumbnails;
        const thumbnailUrl = (thumbnails.standard && thumbnails.standard.url) ||
          (thumbnails.high && thumbnails.high.url) ||
          (thumbnails.medium && thumbnails.medium.url) ||
          thumbnails.default.url;
        return {
          videoId: item.snippet.resourceId.videoId,
          title: item.snippet.title,
          thumbnail: thumbnailUrl,
          language: language
        };
      });
      allVideos = allVideos.concat(videos);
      nextPageToken = data.nextPageToken;
    } while (nextPageToken);

    const level = Object.keys(PLAYLISTS).find(key => PLAYLISTS[key] === playlistId);
    if (level && CUSTOM_TITLES[language] && CUSTOM_TITLES[language][level]) {
      return allVideos.map((video, index) => {
        if (CUSTOM_TITLES[language][level][index]) {
          video.title = CUSTOM_TITLES[language][level][index];
        }
        return video;
      });
    }
    return allVideos;
  } catch (error) {
    console.error(`Error fetching videos for playlist ${playlistId}:`, error);
    return [];
  }
}

async function fetchAllVideosFromAPI(language) {
  const videoData = {};
  for (const level in PLAYLISTS) {
    const playlistId = PLAYLISTS[level];
    const videos = await fetchVideosForPlaylist(playlistId, language);
    videos.forEach((video, index) => {
      videoData[video.videoId] = {
        ...video,
        level: level,
        playlistId: playlistId,
        index: index
      };
    });
  }
  return videoData;
}

async function fetchAndCacheAllVideos(language = 'en') {
  const cacheKey = `allVideosData_${language}`;

  try {
    const cachedData = localStorage.getItem(cacheKey);
    if (cachedData) {
      console.log(`Loading all video data for language '${language}' from localStorage.`);
      return JSON.parse(cachedData);
    }
  } catch (e) {
    console.warn("Could not read from localStorage:", e);
  }

  if (!navigator.onLine) {
    return {};
  }

  console.log(`Fetching all video data for language '${language}' from API...`);
  const apiData = await fetchAllVideosFromAPI(language);

  try {
    if (Object.keys(apiData).length > 0) {
      localStorage.setItem(cacheKey, JSON.stringify(apiData));
      console.log(`All video data for language '${language}' has been saved to localStorage.`);
    }
  } catch (e) {
    console.error('Failed to save video data to localStorage. Storage might be full.', e);
  }

  return apiData;
}

export { fetchPlaylistVideoCounts, fetchVideosForPlaylist, fetchAndCacheAllVideos };
